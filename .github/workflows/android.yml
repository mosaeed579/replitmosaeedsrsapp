name: Build Android APK
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies (Fixed)
        run: |
          # حل مشكلة التعارض باستخدام legacy-peer-deps
          npm install --legacy-peer-deps --force
          npm install @capacitor/cli @capacitor/core @capacitor/android @capacitor/assets @capacitor/filesystem @capacitor/preferences @capacitor-community/file-opener capacitor-voice-recorder --legacy-peer-deps --force

      - name: Build Web Project
        run: npm run build

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Prepare Android Platform
        run: |
          rm -rf android
          npx cap add android
          npx cap copy android
          npx cap sync

      - name: Set App Version to 3.1.0
        run: |
          FILE="android/app/build.gradle"
          # تحديث الإصدار للمستخدم ولنظام أندرويد
          sed -i 's/versionName "1.0"/versionName "3.1.0"/' $FILE
          sed -i 's/versionCode 1/versionCode 4/' $FILE

      - name: Generate App Icons
        run: npx @capacitor/assets generate --android || echo "Icon generation failed"

      - name: Force Inject Permissions
        run: |
          FILE="android/app/src/main/AndroidManifest.xml"
          # حقن الأذونات الضرورية فقط وحذف الإشعارات
          sed -i '/<application/i \    <uses-permission android:name="android.permission.RECORD_AUDIO" />' $FILE
          sed -i '/<application/i \    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />' $FILE
          sed -i '/<application/i \    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />' $FILE
          sed -i '/<application/i \    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />' $FILE
          sed -i 's/<application/<application android:requestLegacyExternalStorage="true"/' $FILE

      - name: Fix Kotlin Conflicts
        run: |
          sed -i 's/dependencies {/dependencies {\n    constraints {\n        implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.9.0")\n        implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.9.0")\n    }/' android/app/build.gradle

      - name: Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: MedStudy-v3.1.0-Fixed
          path: android/app/build/outputs/apk/debug/app-debug.apk
