name: Build Android APK
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies (Fixed)
        run: |
          npm install --legacy-peer-deps --force
          npm install @capacitor/cli @capacitor/core @capacitor/android @capacitor/assets @capacitor/filesystem @capacitor/preferences @capacitor-community/file-opener capacitor-voice-recorder --legacy-peer-deps --force

      - name: Build Web Project
        run: npm run build

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Prepare Android Platform
        run: |
          rm -rf android
          npx cap add android
          npx cap copy android
          npx cap sync

      - name: Set App Version to 3.2.0
        run: |
          FILE="android/app/build.gradle"
          sed -i 's/versionName "1.0"/versionName "3.2.0"/' $FILE
          sed -i 's/versionCode 1/versionCode 5/' $FILE

      - name: Generate App Icons
        run: npx @capacitor/assets generate --android || echo "Icon generation failed"

      - name: Copy Widget Resources
        run: |
          mkdir -p android/app/src/main/res/layout
          mkdir -p android/app/src/main/res/xml
          mkdir -p android/app/src/main/res/drawable
          mkdir -p android/app/src/main/res/values
          mkdir -p android/app/src/main/java/com/medstudy/app
          
          cp android-resources/layout/*.xml android/app/src/main/res/layout/
          cp android-resources/xml/*.xml android/app/src/main/res/xml/
          cp android-resources/drawable/*.xml android/app/src/main/res/drawable/
          cp android-resources/values/*.xml android/app/src/main/res/values/
          cp android-resources/kotlin/*.kt android/app/src/main/java/com/medstudy/app/

      - name: Inject Widget Receivers into AndroidManifest
        run: |
          FILE="android/app/src/main/AndroidManifest.xml"
          
          WIDGET_RECEIVERS='
              <receiver android:name="com.medstudy.app.DueLessonsWidget" android:exported="true">
                  <intent-filter>
                      <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
                  </intent-filter>
                  <meta-data
                      android:name="android.appwidget.provider"
                      android:resource="@xml/due_lessons_widget_info" />
              </receiver>
              <receiver android:name="com.medstudy.app.StudyStatsWidget" android:exported="true">
                  <intent-filter>
                      <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
                  </intent-filter>
                  <meta-data
                      android:name="android.appwidget.provider"
                      android:resource="@xml/study_stats_widget_info" />
              </receiver>
          '
          
          sed -i "s|</application>|${WIDGET_RECEIVERS}\n    </application>|" $FILE

      - name: Force Inject Permissions
        run: |
          FILE="android/app/src/main/AndroidManifest.xml"
          sed -i '/<application/i \    <uses-permission android:name="android.permission.RECORD_AUDIO" />' $FILE
          sed -i '/<application/i \    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />' $FILE
          sed -i '/<application/i \    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />' $FILE
          sed -i '/<application/i \    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />' $FILE
          sed -i 's/<application/<application android:requestLegacyExternalStorage="true"/' $FILE

      - name: Fix Kotlin Conflicts
        run: |
          sed -i 's/dependencies {/dependencies {\n    constraints {\n        implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.9.0")\n        implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.9.0")\n    }/' android/app/build.gradle

      - name: Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: MedStudy-v3.2.0-Widgets
          path: android/app/build/outputs/apk/debug/app-debug.apk
